#include <stdint.h>
#include "tm4c123gh6pm.h"
#include "Nokia5110.h"
#include "SysTick.h"
#include "PLL.h"
#include "Switches.h"


//---------------BMP IMAGES, TEMPORARY move to seperate header later ---//
const unsigned char Viking1[] = {
0x42, 0x4D, 0xC6, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x76, 0x00, 0x00, 0x00, 0x28,
0x00, 0x00, 0x00, 0x10, 0x00, 0x00, 0x00, 0x0A, 0x00, 0x00, 0x00, 0x01, 0x00, 0x04, 0x00,
0x00, 0x00, 0x00, 0x00, 0x50, 0x00, 0x00, 0x00, 0x13, 0x0B, 0x00, 0x00, 0x13, 0x0B, 0x00,
0x00, 0x10, 0x00, 0x00, 0x00, 0x10, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x80, 0x00, 0x00, 0x80, 0x00, 0x00, 0x00, 0x80, 0x80, 0x00, 0x80, 0x00, 0x00, 0x00, 0x80,
0x00, 0x80, 0x00, 0x80, 0x80, 0x00, 0x00, 0x80, 0x80, 0x80, 0x00, 0xC0, 0xC0, 0xC0, 0x00,
0x00, 0x00, 0xFF, 0x00, 0x00, 0xFF, 0x00, 0x00, 0x00, 0xFF, 0xFF, 0x00, 0xFF, 0x00, 0x00,
0x00, 0xFF, 0x00, 0xFF, 0x00, 0xFF, 0xFF, 0x00, 0x00, 0xFF, 0xFF, 0xFF, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0F, 0xF0, 0x0F, 0xF0, 0x00, 0x00, 0x00,
0xF0, 0x0F, 0x00, 0x0F, 0x00, 0x00, 0x00, 0x00, 0xF0, 0xFF, 0xFF, 0xFF, 0xF0, 0xF0, 0x00,
0x00, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xF0, 0x00, 0x00, 0xF0, 0xFF, 0xFF, 0xFF, 0xF0, 0xF0,
0xF0, 0x00, 0xF0, 0x00, 0xFF, 0xF0, 0x00, 0xFF, 0xF0, 0x00, 0xF0, 0x00, 0xFF, 0xF0, 0x00,
0xFF, 0xF0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00};


const unsigned char VikingBlock[] = {
0x42, 0x4D, 0xC6, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x76, 0x00, 0x00, 0x00, 0x28,
0x00, 0x00, 0x00, 0x10, 0x00, 0x00, 0x00, 0x0A, 0x00, 0x00, 0x00, 0x01, 0x00, 0x04, 0x00,
0x00, 0x00, 0x00, 0x00, 0x50, 0x00, 0x00, 0x00, 0x13, 0x0B, 0x00, 0x00, 0x13, 0x0B, 0x00,
0x00, 0x10, 0x00, 0x00, 0x00, 0x10, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x80, 0x00, 0x00, 0x80, 0x00, 0x00, 0x00, 0x80, 0x80, 0x00, 0x80, 0x00, 0x00, 0x00, 0x80,
0x00, 0x80, 0x00, 0x80, 0x80, 0x00, 0x00, 0x80, 0x80, 0x80, 0x00, 0xC0, 0xC0, 0xC0, 0x00,
0x00, 0x00, 0xFF, 0x00, 0x00, 0xFF, 0x00, 0x00, 0x00, 0xFF, 0xFF, 0x00, 0xFF, 0x00, 0x00,
0x00, 0xFF, 0x00, 0xFF, 0x00, 0xFF, 0xFF, 0x00, 0x00, 0xFF, 0xFF, 0xFF, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0F, 0xF0, 0x0F, 0xF0, 0x00, 0x00, 0x00, 0x00,
0x0F, 0x00, 0x0F, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF, 0xFF, 0xFF, 0xF0, 0x00, 0x0F, 0x00,
0x0F, 0xFF, 0xFF, 0xFF, 0xFF, 0xF0, 0xFF, 0x00, 0x00, 0xFF, 0xFF, 0xFF, 0xF0, 0x0F, 0xF0,
0x00, 0x00, 0x00, 0xFF, 0xF0, 0x00, 0xFF, 0x00, 0x00, 0x00, 0x00, 0xFF, 0xF0, 0x0F, 0xF0,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00};

const unsigned char VikingAttack[] = {
0x42, 0x4D, 0xC6, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x76, 0x00, 0x00, 0x00, 0x28,
0x00, 0x00, 0x00, 0x10, 0x00, 0x00, 0x00, 0x0A, 0x00, 0x00, 0x00, 0x01, 0x00, 0x04, 0x00,
0x00, 0x00, 0x00, 0x00, 0x50, 0x00, 0x00, 0x00, 0x13, 0x0B, 0x00, 0x00, 0x13, 0x0B, 0x00,
0x00, 0x10, 0x00, 0x00, 0x00, 0x10, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x80, 0x00, 0x00, 0x80, 0x00, 0x00, 0x00, 0x80, 0x80, 0x00, 0x80, 0x00, 0x00, 0x00, 0x80,
0x00, 0x80, 0x00, 0x80, 0x80, 0x00, 0x00, 0x80, 0x80, 0x80, 0x00, 0xC0, 0xC0, 0xC0, 0x00,
0x00, 0x00, 0xFF, 0x00, 0x00, 0xFF, 0x00, 0x00, 0x00, 0xFF, 0xFF, 0x00, 0xFF, 0x00, 0x00,
0x00, 0xFF, 0x00, 0xFF, 0x00, 0xFF, 0xFF, 0x00, 0x00, 0xFF, 0xFF, 0xFF, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF, 0x0F, 0xF0, 0x00, 0x00, 0x00, 0x00, 0x00,
0xF0, 0x0F, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0F, 0xFF, 0xFF, 0xF0, 0xF0, 0x00, 0x00, 0x00,
0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x00, 0x0F, 0x00, 0x0F, 0xFF, 0xFF, 0xF0, 0x00, 0xF0, 0x00,
0xFF, 0x00, 0x0F, 0xF0, 0x00, 0x00, 0x0F, 0x0F, 0xFF, 0x00, 0x0F, 0xF0, 0x00, 0x00, 0x00,
0xFF, 0xF0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00};

const unsigned char Arrow[] = {
0x42, 0x4D, 0xC6, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x76, 0x00, 0x00, 0x00, 0x28,
0x00, 0x00, 0x00, 0x10, 0x00, 0x00, 0x00, 0x0A, 0x00, 0x00, 0x00, 0x01, 0x00, 0x04, 0x00,
0x00, 0x00, 0x00, 0x00, 0x50, 0x00, 0x00, 0x00, 0x13, 0x0B, 0x00, 0x00, 0x13, 0x0B, 0x00,
0x00, 0x10, 0x00, 0x00, 0x00, 0x10, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x80, 0x00, 0x00, 0x80, 0x00, 0x00, 0x00, 0x80, 0x80, 0x00, 0x80, 0x00, 0x00, 0x00, 0x80,
0x00, 0x80, 0x00, 0x80, 0x80, 0x00, 0x00, 0x80, 0x80, 0x80, 0x00, 0xC0, 0xC0, 0xC0, 0x00,
0x00, 0x00, 0xFF, 0x00, 0x00, 0xFF, 0x00, 0x00, 0x00, 0xFF, 0xFF, 0x00, 0xFF, 0x00, 0x00,
0x00, 0xFF, 0x00, 0xFF, 0x00, 0xFF, 0xFF, 0x00, 0x00, 0xFF, 0xFF, 0xFF, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xF0,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0F, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0xF0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0F, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0xFF, 0xF0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0xF0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00};

//----------------------------Global variables---------------------------//
//0 means start screen, 1 means game in progress, -1 means game beaten
int GameStart = 0;

#define MAX_LEVEL 5
unsigned int Level = 0;

typedef struct Viking_struct
{
    unsigned long x;
    unsigned long y;
    const unsigned char *img;
    int hp;
    char stance;
}Viking;

Viking Player;

typedef struct Enemy_struct
{
    unsigned long x;
    unsigned long y;
    const unsigned char *img;
}Enemy;

Enemy Arrows[3];
Enemy Knight;

void Game_Init(void)
{
    //Initialize player character
    Player.x = 0;
    Player.y = 48;
    Player.img = Viking1;
    Player.hp = 5;

    //Initialize enemy knights
    Knight.x = 80;
    Knight.y = 48;
    Knight.img = Viking1; //TODO:**knight sprite**

    //Initialize arrows
    for(int i = 0; i < 3; i++)
    {
        Arrows[i].x = 75 + i*5;
        Arrows[i].y = i*10;
        Arrows[i].img = Arrow;
    }

    //Output game start screen to Nokia5110 LCD
    Nokia5110_SetCursor(2, 0);
    Nokia5110_OutString("Storm The");
    Nokia5110_SetCursor(3, 1);
    Nokia5110_OutString("Castle!");
    Nokia5110_SetCursor(1, 3);
    Nokia5110_OutString("Press walk");
    Nokia5110_SetCursor(3, 4);
    Nokia5110_OutString("button");
}

//Returns a random number between 1 and 2
unsigned int Random(unsigned long seed);

//----------------------------Interrupt Handlers---------------------------//
void SysTick_Handler(void);

//-----------------------------Main Program--------------------------------//
int main(void)
{
    PLL_Init();                     //80 Mhz Clock
    Nokia5110_Init();				//initialize Nokia5110 LCD
    Switches_Init();

    //Clock is set to 80 MHz, each SysTick takes 1/80MHz = 12.5 ns
    //Divide: 80MHz/30Hz = 2666667 = value we need to pass to reload register
    SysTick_Init(2666667);	        //initialize SysTick for 30 Hz interrupts

    Nokia5110_Clear();              //Clear junk from previous instance
    Game_Init();                    //Initialize game and sprites

    while(1)
    {

    }
}


void SysTick_Handler(void)
{
    //If the game hasn't started start the game
    if(Walk && (GameStart == 0))
    {
        Nokia5110_ClearBuffer();        //Clear start screen
        //Place player at start
        Nokia5110_PrintBMP(Player.x, Player.y, Player.img, 0);
        Nokia5110_DisplayBuffer();      //Display player

        GameStart = 1;                  //Let interrupt know the game has started
        Level = 1;                      //Start on first level
    }

    //If max_level has not been reached and player at the end of current level,
    //move player to next level, else end screen
    if(Level <= MAX_LEVEL && Player.x >= 70)
    {
        Level++;                        //increment current level
        Player.x = 0;
        //Initialize arrows
        for(int i = 0; i < 3; i++)
        {
            Arrows[i].x = 75 + i*5;
            Arrows[i].y = i*10;
            Arrows[i].img = Arrow;
        }

        if(Level == MAX_LEVEL)
        {
            //Output game start screen to Nokia5110 LCD
            Nokia5110_Clear();
            Nokia5110_SetCursor(2, 0);
            Nokia5110_OutString("Victory!");
            Nokia5110_SetCursor(2, 2);
            Nokia5110_OutString("The loot");
            Nokia5110_SetCursor(2, 3);
            Nokia5110_OutString("is yours!");
            GameStart = -1;
        }
    }

    if(GameStart == 1)
    {

        if(Walk)
        {
            Player.x += 2;
            Nokia5110_ClearBuffer();
            Player.img = Viking1;
        }
        else if(Block)
        {
            Player.stance = 'b';
            Nokia5110_ClearBuffer();
            Player.img = VikingBlock;
        }
        else if(Attack)
        {
            Player.stance = 'a';
            Nokia5110_ClearBuffer();
            Player.img = VikingAttack;
        }


        if(Arrows[0].y == 48)
            Nokia5110_ClearBuffer();
        if(Arrows[1].y == 48)
            Nokia5110_ClearBuffer();
        if(Arrows[2].y == 48)
            Nokia5110_ClearBuffer();

        Arrows[0].x -= Random(NVIC_ST_CURRENT_R);
        Arrows[0].y += Random(NVIC_ST_CURRENT_R);
        Arrows[1].x -= Random(NVIC_ST_CURRENT_R);
        Arrows[1].y += Random(NVIC_ST_CURRENT_R);
        Arrows[2].x -= Random(NVIC_ST_CURRENT_R);
        Arrows[2].y += Random(NVIC_ST_CURRENT_R);

        Nokia5110_PrintBMP(Arrows[0].x, Arrows[0].y, Arrows[0].img, 0);
        Nokia5110_PrintBMP(Arrows[1].x, Arrows[1].y, Arrows[1].img, 0);
        Nokia5110_PrintBMP(Arrows[2].x, Arrows[2].y, Arrows[2].img, 0);
        Nokia5110_PrintBMP(Player.x, Player.y, Player.img, 0);
        Nokia5110_DisplayBuffer();
    }
}

unsigned int Random(unsigned long seed)
{
    seed = ((((1664525 * seed + 1013904223) % 4294967296) >> 24) % 2) + 1;
    if(seed > 0)
        return seed;
    else
        return 1;
}


